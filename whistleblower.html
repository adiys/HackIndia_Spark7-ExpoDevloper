<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WhistleBlower</title>

    <link href="https://unpkg.com/cirrus-ui" type="text/css" rel="stylesheet" />
    <link
      rel="stylesheet"
      href="https://use.fontawesome.com/releases/v5.8.1/css/all.css"
      integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf"
      crossorigin="anonymous"
    />

    <script src="./js/web3.min.js"></script>

    <link
      href="https://fonts.googleapis.com/css?family=Nunito+Sans:200,300,400,600,700"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css?family=Montserrat:400,700"
      rel="stylesheet"
    />

    <script src="./js/web3.min.js"></script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.js"></script>
    <script src="https://unpkg.com/ipfs-http-client@30.1.3/dist/index.js"></script>
    <script src="https://bundle.run/buffer@5.2.1"></script>
  </head>
  <body>
    <div id="header" class="header header-top header-fixed unselectable">
      <div class="header-brand">
        <div class="nav-item no-hover">
          <a href="./index.html">
            <h5 class="title">
              WhistleBlower
              <svg
                xmlns="http://www.w3.org/2000/svg"
                x="0px"
                y="0px"
                width="50"
                height="50"
                viewBox="0 0 226 226"
                style=" fill:#000000;"
              >
                <g
                  fill="none"
                  fill-rule="nonzero"
                  stroke="none"
                  stroke-width="1"
                  stroke-linecap="butt"
                  stroke-linejoin="miter"
                  stroke-miterlimit="10"
                  stroke-dasharray=""
                  stroke-dashoffset="0"
                  font-family="none"
                  font-weight="none"
                  font-size="none"
                  text-anchor="none"
                  style="mix-blend-mode: normal"
                >
                  <path d="M0,226v-226h226v226z" fill="none"></path>
                  <g fill="#8292a2">
                    <path
                      d="M175.715,4.52c-1.00641,0.10594 -1.95984,0.565 -2.68375,1.27125l-40.68,40.68c-1.80094,1.80094 -1.80094,4.69656 0,6.4975c1.80094,1.80094 4.69656,1.80094 6.4975,0l40.68,-40.68c1.46547,-1.35953 1.85391,-3.51359 0.97109,-5.29687c-0.86516,-1.80094 -2.825,-2.78969 -4.78484,-2.47187zM126.13625,17.93875c-0.19422,0.03531 -0.38844,0.08828 -0.565,0.14125c-1.48313,0.33547 -2.71906,1.39484 -3.24875,2.825l-9.04,22.6c-0.93578,2.34828 0.19422,4.99672 2.5425,5.9325c2.34828,0.93578 4.99672,-0.19422 5.9325,-2.5425l9.04,-22.6c0.67094,-1.48313 0.49437,-3.23109 -0.47672,-4.53766c-0.95344,-1.32422 -2.56016,-2.01281 -4.18453,-1.81859zM13.56,67.8c-7.43328,0 -13.56,6.12672 -13.56,13.56l-0.42375,35.595c0,0.05297 0,0.08828 0,0.14125c0,6.62109 4.62594,12.50063 11.3,13.8425c0.08828,0.05297 0.19422,0.10594 0.2825,0.14125c5.01437,0.63563 10.29359,-1.18297 13.2775,-5.50875c0.03531,-0.05297 0.10594,-0.08828 0.14125,-0.14125c1.64203,-2.24234 3.31938,-3.39 5.65,-3.39c3.69016,0 6.97422,0.44141 10.735,1.27125c0.05297,0.01766 0.08828,-0.01766 0.14125,0l5.22625,1.27125c0.05297,0 0.08828,0 0.14125,0c18.02703,4.20219 33.29969,16.89703 42.23375,33.47625c10.735,19.51016 31.74594,32.75234 56.07625,31.78125c27.61437,-0.86516 51.25609,-21.32875 57.20625,-47.60125c2.41891,1.50078 5.15562,2.40125 8.1925,2.40125c8.68688,0 15.82,-7.13313 15.82,-15.82c0,-8.68687 -7.13312,-15.82 -15.82,-15.82c-3.07219,0 -5.89719,0.86516 -8.33375,2.40125c-6.09141,-27.12 -30.33344,-47.60125 -59.46625,-47.60125h-24.86c-1.62437,-0.01766 -3.14281,0.8475 -3.955,2.26l-9.605,16.80875v-14.54875c0,-2.48953 -2.03047,-4.52 -4.52,-4.52zM13.56,76.84h81.36v27.12c-0.03531,2.06578 1.35953,3.90203 3.35469,4.43172c2.01281,0.54734 4.11391,-0.35312 5.12031,-2.17172l16.80875,-29.38h22.17625c28.86797,0 52.05063,23.35922 51.98,51.98c0,0.70625 0.03531,1.4125 0,2.11875c-0.82984,26.46672 -23.39453,49.03141 -49.86125,49.86125c-20.86969,0.82984 -38.72016,-10.32891 -47.88375,-26.97875c-10.02875,-18.62734 -27.24359,-33.12312 -48.025,-37.99625h-0.14125l-5.3675,-1.27125c0,-0.05297 0,-0.08828 0,-0.14125c-4.30813,-0.95344 -8.45734,-1.4125 -12.85375,-1.4125c-1.07703,0 -2.11875,0.07063 -3.1075,0.2825v-18.3625c0.03531,-1.39484 -0.58266,-2.71906 -1.65969,-3.60187c-1.05937,-0.88281 -2.48953,-1.21828 -3.84906,-0.91813c-2.10109,0.47672 -3.58422,2.36594 -3.53125,4.52v24.295c-0.31781,0.38844 -0.70625,0.72391 -0.98875,1.13c0,0.05297 0,0.08828 0,0.14125c-0.65328,0.97109 -2.66609,1.81859 -4.8025,1.55375c-2.18937,-0.60031 -3.6725,-2.64844 -3.6725,-4.94375l0.42375,-35.73625c0,-2.50719 2.01281,-4.52 4.52,-4.52zM210.18,122.04c3.79609,0 6.78,2.98391 6.78,6.78c0,3.79609 -2.98391,6.78 -6.78,6.78c-3.79609,0 -6.78,-2.98391 -6.78,-6.78c0,-3.79609 2.98391,-6.78 6.78,-6.78z"
                    ></path>
                  </g>
                </g>
              </svg>
            </h5>
          </a>
        </div>
        <div class="nav-item nav-btn" id="header-btn">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </div>
      <div class="header-nav" id="header-menu">
        <div class="nav-right">
          <div class="nav-item">
            <a class="smoothScroll" href="./pendingclaims.html">
              <span class="icon">
                <i class="fas fa-wrapper fa-clock small"></i>
              </span>
              Pending Claims
            </a>
          </div>
          <div class="nav-item has-sub" style="padding: 0.5rem;">
            <div class="list-dropdown dropdown-right">
              <div class="btn-group">
                <button class="btn-success u-no-padding">
                  <a
                    class="font-normal"
                    href="./whistleblower.html"
                    target=""
                  >
                    <span style="color: white;">Login (WhistleBlower)</span>
                  </a>
                </button>
              </div>
            </div>
          </div>
          <div class="nav-item has-sub" style="padding: 0.5rem;">
            <div class="list-dropdown dropdown-right">
              <div class="btn-group">
                <button class="btn-success u-no-padding">
                  <a
                    class="font-normal"
                    href="./organization.html"
                    target=""
                  >
                    <span style="color: white;">Login (Organization)</span>
                  </a>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="hero fullscreen" style="margin-top: 3.5em;">
      <div class="row u-no-padding">
        <div class="col-6 u-no-padding level">
          <div class="u-text-left w-100">
            <div class="content">
              <h4>Add New Case!</h4>

              <div class="divider"></div>

              <div class="form-section changeInput">
                <label class="font-semibold">Title:</label>
                <div class="input-control">
                  <input
                    class="input-contains-icon"
                    id="title"
                    name="title"
                    placeholder=""
                    type="text"
                    value=""
                  />
                </div>
              </div>

              <div class="form-section changeInput">
                <label class="font-semibold">Description:</label>
                <div class="input-control">
                  <input
                    class="input-contains-icon"
                    id="desc"
                    name="desc"
                    placeholder=""
                    type="text"
                    value=""
                  />
                </div>
              </div>

              <div class="form-section changeInput">
                <label class="font-semibold">Organization Id:</label>
                <div class="input-control">
                  <input
                    class="input-contains-icon"
                    id="orgid"
                    name="orgid"
                    placeholder=""
                    type="text"
                    value=""
                  />
                </div>
              </div>

              <div class="form-section changeInput">
                <label class="font-semibold">Proof:</label>
                <div class="input-control">
                  <input type="file" id="upload" />
                </div>
              </div>

              <div class="form-section u-text-right">
                <div class="btn-container u-inline-block">
                  <button
                    class="white"
                    style="background: var(--cirrus-success)"
                    id="create"
                  >
                    Create
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-6 u-no-padding">
          <div
            class="h-100"
            style="background: url('./img/splashLeaves2.jpg'); background-size: cover; background-position: center; box-shadow: inset 5px 0px 9px 1px #00000017; min-height: 300px;"
          ></div>
        </div>
      </div>
    </div>

    <script>
      const GAS = 500000;
      const GAS_PRICE = "20000000000";

      if (window.ethereum) {
        window.web3 = new Web3(ethereum);
        try {
          // Request account access if needed
          ethereum.enable();
          // Acccounts now exposed
          window.web3.eth.net.getId().then(r => {
            // 5 == ID for Goerli
            if(r != 5) {
              alert("Connect Metamask to Goerli Testnet!")
            }
          });
        } catch (error) {
          // User denied account access...
        }
      }
      // Legacy dapp browsers...
      else if (window.web3) {
        window.web3 = new Web3(web3.currentProvider);
        // Acccounts always exposed
      }
      // Non-dapp browsers...
      else {
        console.log(
          "Non-Ethereum browser detected. You should consider trying MetaMask!"
        );
      }

      web3.eth.getAccounts((err, res) => {
        web3.eth.defaultAccount = res[0];
        console.log(web3.eth.defaultAccount);
      });

      var contract = new web3.eth.Contract(
        [
          {
            inputs: [],
            payable: false,
            stateMutability: "nonpayable",
            type: "constructor"
          },
          {
            constant: false,
            inputs: [
              {
                internalType: "string",
                name: "_title",
                type: "string"
              },
              {
                internalType: "string",
                name: "_desc",
                type: "string"
              },
              {
                internalType: "uint256",
                name: "_orgId",
                type: "uint256"
              },
              {
                internalType: "string",
                name: "_proof",
                type: "string"
              }
            ],
            name: "addCase",
            outputs: [],
            payable: false,
            stateMutability: "nonpayable",
            type: "function"
          },
          {
            constant: true,
            inputs: [
              {
                internalType: "uint256",
                name: "",
                type: "uint256"
              }
            ],
            name: "cases",
            outputs: [
              {
                internalType: "uint256",
                name: "id",
                type: "uint256"
              },
              {
                internalType: "string",
                name: "title",
                type: "string"
              },
              {
                internalType: "string",
                name: "desc",
                type: "string"
              },
              {
                internalType: "address",
                name: "org",
                type: "address"
              },
              {
                internalType: "string",
                name: "proof",
                type: "string"
              },
              {
                internalType: "uint8",
                name: "validity",
                type: "uint8"
              }
            ],
            payable: false,
            stateMutability: "view",
            type: "function"
          },
          {
            constant: true,
            inputs: [],
            name: "getCaseCount",
            outputs: [
              {
                internalType: "uint256",
                name: "_count",
                type: "uint256"
              }
            ],
            payable: false,
            stateMutability: "view",
            type: "function"
          },
          {
            constant: true,
            inputs: [],
            name: "getOrgCount",
            outputs: [
              {
                internalType: "uint256",
                name: "_count",
                type: "uint256"
              }
            ],
            payable: false,
            stateMutability: "view",
            type: "function"
          },
          {
            constant: true,
            inputs: [
              {
                internalType: "uint256",
                name: "",
                type: "uint256"
              }
            ],
            name: "orgs",
            outputs: [
              {
                internalType: "uint256",
                name: "id",
                type: "uint256"
              },
              {
                internalType: "address",
                name: "addr",
                type: "address"
              },
              {
                internalType: "string",
                name: "name",
                type: "string"
              },
              {
                internalType: "uint8",
                name: "otype",
                type: "uint8"
              },
              {
                internalType: "string",
                name: "url",
                type: "string"
              }
            ],
            payable: false,
            stateMutability: "view",
            type: "function"
          },
          {
            constant: true,
            inputs: [],
            name: "owner",
            outputs: [
              {
                internalType: "address",
                name: "",
                type: "address"
              }
            ],
            payable: false,
            stateMutability: "view",
            type: "function"
          },
          {
            constant: false,
            inputs: [
              {
                internalType: "string",
                name: "_name",
                type: "string"
              },
              {
                internalType: "uint8",
                name: "_type",
                type: "uint8"
              },
              {
                internalType: "string",
                name: "_url",
                type: "string"
              },
              {
                internalType: "address",
                name: "_orgAddr",
                type: "address"
              }
            ],
            name: "registerOrg",
            outputs: [],
            payable: false,
            stateMutability: "nonpayable",
            type: "function"
          },
          {
            constant: false,
            inputs: [
              {
                internalType: "uint256",
                name: "_caseId",
                type: "uint256"
              },
              {
                internalType: "bool",
                name: "_isValid",
                type: "bool"
              }
            ],
            name: "verifyProof",
            outputs: [],
            payable: false,
            stateMutability: "nonpayable",
            type: "function"
          }
        ],
        "0x351386ED5405e9f2502a1FdA5C4554BE1eB12EC8"
      );

      var ipfshash;
      const ipfs = window.IpfsHttpClient("ipfs.infura.io", "5001", {
        protocol: "https"
      });

      $("#upload").on("change", function() {
        $("#create").css("background", "grey");
        $("#create").addClass(
          "animated loading u-center loading-right loading-white"
        );
        $("#create").text("Uploading");
        var reader = new FileReader();
        reader.onload = function(e) {
          const magic_array_buffer_converted_to_buffer = buffer.Buffer(
            reader.result
          ); // honestly as a web developer I do not fully appreciate the difference between buffer and arrayBuffer
          ipfs.add(magic_array_buffer_converted_to_buffer, (err, result) => {
            console.log(err, result);

            ipfshash = result[0].hash;
            $("#create").removeClass(
              "animated loading u-center loading-right loading-white"
            );
            $("#create").css("background", "var(--cirrus-success)");
            $("#create").text("CREATE");
          });
        };
        reader.readAsArrayBuffer(this.files[0]);
      });

      $(document).ready(function() {
        $("#create").click(function() {
          $("#create").addClass(
            "animated loading u-center loading-right loading-white"
          );

          var title = $("#title").val();
          var desc = $("#desc").val();
          var orgid = $("#orgid").val();
          proof = ipfshash;

          contract.methods
            .addCase(title, desc, orgid, proof)
            .send({ from: web3.eth.defaultAccount })
            .then(r => {
              contract.methods.getCaseCount().call((err, caseno) => {
                $("#create").removeClass(
                  "animated loading u-center loading-right loading-white"
                );
                $("#create").text("CASENO is: " + (caseno - 1));
                console.log(caseno, "CASENO");
              });
            });
        });
      });
    </script>
  </body>
</html>
